generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Folder {
  id                String        @id @default(cuid())
  name              String
  isPrivate         Boolean       @default(true)
  visible           Boolean       @default(true)
  uniqueUrl         String        @unique
  passphrase        String?
  inGridView        Boolean       @default(false)
  folderThumbnailId String?       @unique
  deletedAt         DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  accessLinks       AccessLink[]
  downloadJobs      DownloadJob[]
  files             File[]
  thumbnail         File?         @relation("FolderThumbnail", fields: [folderThumbnailId], references: [id])

  @@index([createdAt])
  @@index([visible])
}

model File {
  id                 String            @id @default(cuid())
  fileName           String
  hash               String            @unique
  mimeType           String?
  width              Int?
  height             Int?
  duration           Float?
  fileSize           BigInt
  fileType           FileType
  isLive             Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  folderId           String
  downloadJobFiles   DownloadJobFile[]
  folder             Folder            @relation(fields: [folderId], references: [id], onDelete: Cascade)
  thumbnailForFolder Folder?           @relation("FolderThumbnail")
  variants           Variant[]

  @@unique([folderId, fileName])
  @@index([folderId])
  @@index([fileType])
  @@index([createdAt])
}

model Variant {
  id        String   @id @default(cuid())
  name      String
  width     Int?
  height    Int?
  size      BigInt
  path      String
  codec     String?
  createdAt DateTime @default(now())
  fileId    String
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, name])
  @@index([fileId])
}

model AccessLink {
  id        String    @id @default(cuid())
  token     String    @unique @default(cuid())
  expiresAt DateTime?
  usesLeft  Int       @default(1)
  createdAt DateTime  @default(now())
  folderId  String
  folder    Folder    @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([folderId], map: "AccessLink_folderId_fkey")
}

model DownloadJob {
  id         String            @id @default(cuid())
  status     JobStatus         @default(PENDING)
  zipPath    String?
  zipSize    BigInt?
  progress   Int               @default(0)
  failReason String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  folderId   String
  folder     Folder            @relation(fields: [folderId], references: [id], onDelete: Cascade)
  files      DownloadJobFile[]

  @@index([folderId], map: "DownloadJob_folderId_fkey")
}

model DownloadJobFile {
  id     String      @id @default(cuid())
  status JobStatus   @default(PENDING)
  fileId String
  jobId  String
  file   File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  job    DownloadJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, fileId])
  @@index([fileId], map: "DownloadJobFile_fileId_fkey")
}

model Setting {
  key   String @id
  value String
}

enum FileType {
  image
  video
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
